{% extends "form_builder/base.html" %}
{% load static %}

{% block title %}Build: {{ form.title }}{% endblock %}

{% block content %}
<div x-data="formBuilder()" x-init="init()" 
     @mousemove.window="doResize($event)" 
     @mouseup.window="stopResize()"
     class="flex h-full w-full bg-neutral-900 flex-1 overflow-hidden">

    <main class="flex-1 bg-black flex flex-col overflow-hidden min-w-0">
        <div class="flex items-center justify-between p-4 border-b border-neutral-800 flex-shrink-0">
            <div>
                <a href="{% url 'form_builder:form_list' %}" class="text-sm text-orange-500 hover:text-orange-400 flex items-center gap-1 mb-2">
                    <span class="material-symbols-outlined text-base">arrow_back</span>
                    Back to All Forms
                </a>
                <h2 class="text-xl font-bold text-white" x-text="form.title"></h2>
            </div>
            <button @click="addQuestion()" class="flex items-center justify-center space-x-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                <span class="material-symbols-outlined">add</span>
                <span>Add Question</span>
            </button>
        </div>
        <div id="questions-list-container" class="flex-1 overflow-y-auto p-4 space-y-3">
            <template x-if="form.questions.length === 0">
                <div class="text-center py-12 text-neutral-500">
                    <span class="material-symbols-outlined text-6xl">quiz</span>
                    <h3 class="mt-4 font-semibold text-neutral-400">No Questions Yet</h3>
                    <p class="text-sm">Click "Add Question" to get started.</p>
                </div>
            </template>
            <template x-for="(question, index) in form.questions" :key="question.id || index">
                <div @click="selectQuestion(question)"
                     class="p-4 rounded-lg border cursor-pointer transition-colors"
                     :class="{
                         'bg-neutral-800/50 border-neutral-700 hover:bg-neutral-700/50': !isSelected(question),
                         'bg-orange-900/30 border-orange-700 ring-2 ring-orange-600': isSelected(question)
                     }">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-white" x-text="`${index + 1}. ${question.question_text || 'New Question'}`"></p>
                            <span class="text-xs text-neutral-400" x-text="`${getQuestionTypeName(question.type)} ${question.is_required ? 'â€¢ Required' : ''}`"></span>
                        </div>
                        <span class="material-symbols-outlined text-neutral-500">drag_indicator</span>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <div @mousedown.prevent="startResize()" class="w-1.5 flex-shrink-0 cursor-col-resize bg-neutral-800 hover:bg-orange-600 transition-colors"></div>

    <aside id="right-panel" class="flex-shrink-0 bg-neutral-950 border-l border-neutral-800 flex flex-col" :style="`width: ${rightPanelWidth}px`">
        <div x-show="!selectedQuestion" class="flex flex-col items-center justify-center h-full text-center text-neutral-600 p-4">
            <span class="material-symbols-outlined text-6xl">edit_note</span>
            <h3 class="mt-4 font-semibold text-neutral-400">Question Editor</h3>
            <p class="text-sm">Select a question to edit its details, or add a new one.</p>
        </div>
        
        <div x-show="selectedQuestion" x-cloak class="flex flex-col h-full">
            {% include "form_builder/_question_editor.html" %}
        </div>
    </aside>
</div>

{% include "form_builder/_modals.html" %}
{{ form_schema_json|json_script:"form-schema-data" }}
{% csrf_token %}

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('formBuilder', () => ({
        form: {},
        selectedQuestion: null,
        isDirty: false,
        showApiModal: false,
        showEditFormModal: false,
        showDeleteModal: { open: false, type: '', id: null },
        
        isResizing: false,
        rightPanelWidth: 420,
        minPanelWidth: 320,
        maxPanelWidth: 800,

        questionTypes: [
            { value: 'short_answer', name: 'Short Answer' },
            { value: 'paragraph', name: 'Paragraph' },
            { value: 'multiple_choice', name: 'Multiple Choice' },
            { value: 'checkboxes', name: 'Checkboxes' },
            { value: 'dropdown', name: 'Dropdown' },
            { value: 'linear_scale', name: 'Linear Scale' },
            { value: 'rating', name: 'Rating' },
            { value: 'multiple_choice_grid', name: 'Multiple Choice Grid' },
            { value: 'date', name: 'Date' },
            { value: 'time', name: 'Time' },
        ],

        apiUrls: {
            schema: `/form_builder/api/forms/{{ form.slug }}/schema/`,
            questions: '/form_builder/api/questions/',
        },
        
        init() {
            this.form = JSON.parse(document.getElementById('form-schema-data').textContent);
            this.form.questions.sort((a, b) => a.display_order - b.display_order);
        },

        startResize() {
            this.isResizing = true;
        },

        doResize(event) {
            if (!this.isResizing) return;
            const newWidth = window.innerWidth - event.clientX;
            if (newWidth >= this.minPanelWidth && newWidth <= this.maxPanelWidth) {
                this.rightPanelWidth = newWidth;
            }
        },

        stopResize() {
            this.isResizing = false;
        },

        getQuestionTypeName(value) {
            const type = this.questionTypes.find(t => t.value === value);
            return type ? type.name : 'Unknown';
        },

        isSelected(question) {
            return this.selectedQuestion && this.selectedQuestion.id === question.id;
        },

        markDirty() {
            this.isDirty = true;
        },

        selectQuestion(question) {
            if (this.isDirty && !confirm('You have unsaved changes that will be lost. Continue?')) {
                return;
            }
            this.selectedQuestion = JSON.parse(JSON.stringify(question));
            if (!this.selectedQuestion.question_config) this.selectedQuestion.question_config = {};
            if (!this.selectedQuestion.options) this.selectedQuestion.options = [];
            if (!this.selectedQuestion.grid_rows) this.selectedQuestion.grid_rows = [];
            if (!this.selectedQuestion.grid_columns) this.selectedQuestion.grid_columns = [];
            if (!this.selectedQuestion.conditions) this.selectedQuestion.conditions = [];
            this.isDirty = false;
        },

        unselectQuestion() {
            if (this.isDirty && !confirm('You have unsaved changes that will be lost. Continue?')) {
                return;
            }
            this.selectedQuestion = null;
            this.isDirty = false;
        },

        async refreshForm() {
            const response = await this.apiCall(this.apiUrls.schema);
            if (response.ok) {
                const newForm = await response.json();
                newForm.questions.sort((a, b) => a.display_order - b.display_order);
                this.form = newForm;
                
                if (this.selectedQuestion) {
                    const updated = this.form.questions.find(q => q.id === this.selectedQuestion.id);
                    if (updated) {
                        this.selectQuestion(updated);
                    } else {
                        this.selectedQuestion = null;
                    }
                }
            }
        },

        apiCall(url, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            };
            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);
            return fetch(url, config);
        },

        async addQuestion() {
            const payload = {
                form: this.form.id,
                question_text: 'Untitled Question',
                type: 'short_answer',
                display_order: this.form.questions.length,
            };
            const response = await this.apiCall(this.apiUrls.questions, 'POST', payload);
            if (response.ok) {
                const newQuestion = await response.json();
                await this.refreshForm();
                const toSelect = this.form.questions.find(q => q.id === newQuestion.id);
                if (toSelect) this.selectQuestion(toSelect);
            } else {
                alert('Failed to add new question.');
            }
        },

        async saveQuestion() {
            if (!this.selectedQuestion || !this.isDirty) return;
            const url = `${this.apiUrls.questions}${this.selectedQuestion.id}/`;
            const response = await this.apiCall(url, 'PUT', this.selectedQuestion);
            if (response.ok) {
                this.isDirty = false;
                const newForm = await response.json();
                newForm.questions.sort((a, b) => a.display_order - b.display_order);
                this.form = newForm;
                const updated = this.form.questions.find(q => q.id === this.selectedQuestion.id);
                this.selectedQuestion = updated ? JSON.parse(JSON.stringify(updated)) : null;
            } else {
                alert('Failed to save question: ' + JSON.stringify(await response.json()));
            }
        },

        confirmDeleteQuestion(id) {
            this.showDeleteModal = { open: true, type: 'Question', id: id };
        },

        async deleteQuestion() {
            const id = this.showDeleteModal.id;
            if (!id) return;
            const url = `${this.apiUrls.questions}${id}/`;
            const response = await this.apiCall(url, 'DELETE');
            if (response.ok) {
                this.selectedQuestion = null;
                this.isDirty = false;
                await this.refreshForm();
            } else {
                alert(`Failed to delete question.`);
            }
            this.showDeleteModal = { open: false, type: '', id: null };
        },

        addOption() {
            if (!this.selectedQuestion.options) this.selectedQuestion.options = [];
            this.selectedQuestion.options.push({ label: `Option ${this.selectedQuestion.options.length + 1}`, value: '' });
            this.markDirty();
        },

        removeOption(index) {
            this.selectedQuestion.options.splice(index, 1);
            this.markDirty();
        },

        addGridRow() {
            if (!this.selectedQuestion.grid_rows) this.selectedQuestion.grid_rows = [];
            this.selectedQuestion.grid_rows.push({ label: `Row ${this.selectedQuestion.grid_rows.length + 1}`, value: '' });
            this.markDirty();
        },

        removeGridRow(index) {
            this.selectedQuestion.grid_rows.splice(index, 1);
            this.markDirty();
        },

        addGridColumn() {
            if (!this.selectedQuestion.grid_columns) this.selectedQuestion.grid_columns = [];
            this.selectedQuestion.grid_columns.push({ label: `Column ${this.selectedQuestion.grid_columns.length + 1}`, value: '' });
            this.markDirty();
        },

        removeGridColumn(index) {
            this.selectedQuestion.grid_columns.splice(index, 1);
            this.markDirty();
        },

        dependableQuestions() {
            if (!this.selectedQuestion) return [];
            const currentIndex = this.form.questions.findIndex(q => q.id === this.selectedQuestion.id);
            if (currentIndex === -1) return [];
            return this.form.questions.filter((q, index) => q.id !== this.selectedQuestion.id && index < currentIndex);
        },

        getDependentQuestionType(questionId) {
            if (!questionId) return null;
            const question = this.form.questions.find(q => q.id == questionId);
            return question ? question.type : null;
        },

        getTriggerOptions(questionId) {
            if (!questionId) return [];
            const question = this.form.questions.find(q => q.id == questionId);
            return question ? question.options : [];
        },

        addCondition() {
            if (!this.selectedQuestion.conditions) {
                this.selectedQuestion.conditions = [];
            }
            this.selectedQuestion.conditions.push({
                condition_type: 'show_if',
                depends_on_question: '',
                trigger_value: ''
            });
            this.markDirty();
        },

        removeCondition(index) {
            this.selectedQuestion.conditions.splice(index, 1);
            this.markDirty();
        },

        async saveFormDetails() {
            const formElement = document.getElementById('edit-form-details');
            const formData = new FormData(formElement);
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            if (response.ok) {
                this.showEditFormModal = false;
                this.form.title = formData.get('title');
                this.form.description = formData.get('description');
            } else {
                alert('Failed to update form details.');
            }
        }
    }));
});
</script>
{% endblock %}