{% extends "base.html" %}
{% load static %}

{% block title %}Build: {{ form.title }}{% endblock %}

{% block content %}
<div x-data="formBuilder()" x-init="init()">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <a href="{% url 'form_builder:form_list' %}" class="text-sm text-orange-500 hover:text-orange-400 flex items-center gap-1 mb-2">
                <span class="material-symbols-outlined text-base">arrow_back</span>
                Back to All Forms
            </a>
            <h1 class="text-3xl font-bold text-white" x-text="form.title"></h1>
            <p class="text-neutral-400 mt-1" x-text="form.description"></p>
        </div>
        <div class="flex items-center gap-2">
            <button @click="showApiModal = true" class="px-4 py-2 bg-neutral-800 text-neutral-300 text-sm font-semibold rounded-lg hover:bg-neutral-700 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">api</span>
                Get Schema
            </button>
            <button @click="showEditFormModal = true" class="px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-base">edit</span>
                Edit Details
            </button>
        </div>
    </div>

    <div class="bg-neutral-900 border border-neutral-800 rounded-xl p-6 space-y-4">
        <div id="questions-container" class="space-y-4">
            <template x-for="(question, questionIndex) in form.questions" :key="question.id">
                <div class="bg-neutral-800/50 border border-neutral-700 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-neutral-300" x-text="question.question_text"></p>
                            <span class="text-xs text-neutral-500" x-text="`${question.type} ${question.is_required ? '(Required)' : ''}`"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button @click="editQuestion(question)" class="p-2 text-neutral-400 hover:text-white hover:bg-neutral-700 rounded-full transition-colors"><span class="material-symbols-outlined text-base">edit</span></button>
                            <button @click="deleteQuestion(question.id)" class="p-2 text-neutral-400 hover:text-red-400 hover:bg-red-900/50 rounded-full transition-colors"><span class="material-symbols-outlined text-base">delete</span></button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <button @click="addQuestion()" class="w-full mt-4 px-4 py-2 bg-neutral-800 text-neutral-300 text-sm font-semibold rounded-lg hover:bg-neutral-700 transition-colors flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-base">add</span>
            Add Question
        </button>
    </div>

    {% include "form_builder/_modals.html" %}
</div>

{{ form_schema_json|json_script:"form-schema-data" }}
{% csrf_token %}

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('formBuilder', () => ({
        form: {},
        showApiModal: false,
        showEditFormModal: false,
        showQuestionModal: false,
        showDeleteModal: { open: false, type: '', id: null },
        
        currentQuestion: {},
        
        apiUrls: {
            schema: `/form_builder/api/forms/{{ form.slug }}/schema/`,
            questions: '/form_builder/api/questions/',
        },
        
        init() {
            this.form = JSON.parse(document.getElementById('form-schema-data').textContent);
            this.resetCurrentQuestion();
        },

        resetCurrentQuestion() {
            this.currentQuestion = { 
                id: null, 
                question_text: '', 
                type: 'short_answer', 
                is_required: false, 
                form: this.form.id,
                question_config: {},
                validation_rules: {}
            };
        },

        async refreshForm() {
            const response = await this.apiCall(this.apiUrls.schema);
            if (response.ok) {
                this.form = await response.json();
            }
        },

        apiCall(url, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            };
            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }
            return fetch(url, config);
        },

        addQuestion() {
            this.resetCurrentQuestion();
            this.showQuestionModal = true;
        },

        editQuestion(question) {
            this.currentQuestion = JSON.parse(JSON.stringify(question));
            if (!this.currentQuestion.question_config) this.currentQuestion.question_config = {};
            if (!this.currentQuestion.validation_rules) this.currentQuestion.validation_rules = {};
            this.showQuestionModal = true;
        },

        async saveQuestion() {
            const url = this.currentQuestion.id ? `${this.apiUrls.questions}${this.currentQuestion.id}/` : `${this.apiUrls.questions}`;
            const method = this.currentQuestion.id ? 'PUT' : 'POST';
            
            const payload = { ...this.currentQuestion, form: this.form.id };

            const response = await this.apiCall(url, method, payload);
            if (response.ok) {
                this.showQuestionModal = false;
                await this.refreshForm();
            } else {
                const errorData = await response.json();
                alert('Failed to save question: ' + JSON.stringify(errorData));
            }
        },

        deleteQuestion(id) {
            this.showDeleteModal = { open: true, type: 'Question', id: id };
        },

        async confirmDelete() {
            const { type, id } = this.showDeleteModal;
            let url = '';
            if (type === 'Question') url = `${this.apiUrls.questions}${id}/`;
            
            if (url) {
                const response = await this.apiCall(url, 'DELETE');
                if (response.ok) {
                    await this.refreshForm();
                } else {
                    alert(`Failed to delete ${type}.`);
                }
            }
            this.showDeleteModal.open = false;
        },

        async saveFormDetails() {
            const formElement = document.getElementById('edit-form-details');
            const formData = new FormData(formElement);
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            if (response.ok) {
                this.showEditFormModal = false;
                this.form.title = formData.get('title');
                this.form.description = formData.get('description');
            } else {
                alert('Failed to update form details.');
            }
        }
    }));
});
</script>
{% endblock %}